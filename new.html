<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Redirecting…</title>
  <meta name="robots" content="noindex,follow">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px}
  </style>
</head>
<body>
  <h1>Redirecting…</h1>
  <p>If you are not redirected automatically, <a id="fallback" href="/en/">click here</a>.</p>

<script>
(function(){
  // 봇/크롤러면 리다이렉트 차단 (SEO)
  if (/bot|crawler|spider|crawling/i.test(navigator.userAgent)) return;

  // 사용자가 언어를 수동으로 고정해둔 경우
  const pinned = localStorage.getItem('lang_pinned');
  if (pinned) { go(pinned); return; }

  // 쿼리로 강제 지정 ?lang=ko (디버그/캠페인용)
  const p = new URLSearchParams(location.search);
  const override = p.get('lang');
  if (override) { go(normalizeLang(override)); return; }

  // GeoIP → Browser → en
  detectGeoLang(1500).then(l => go(l || detectBrowserLang() || 'en')).catch(_=>{
    go(detectBrowserLang() || 'en');
  });

  function go(lang){
    lang = normalizeLang(lang);
    const path = ('/' + lang + '/');
    document.getElementById('fallback').setAttribute('href', path);
    // 루트에서만 리다이렉트 (이미 /ko/ 같은 하위 경로면 불필요)
    if (location.pathname === '/' || location.pathname === '/index.html') {
      location.replace(path);
    }
  }
  function normalizeLang(l){
    l = String(l||'en').toLowerCase();
    if (l.startsWith('ko')) return 'ko';
    if (l.startsWith('ja')) return 'ja';
    if (l.startsWith('fr')) return 'fr';
    if (l.startsWith('es')) return 'es';
    if (l.startsWith('zh')) return 'zh';
    if (l.startsWith('hi')) return 'hi';
    if (l.startsWith('ar')) return 'ar';
    return 'en';
  }
  async function detectGeoLang(timeoutMs){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch('https://ipwho.is/', {signal: ctrl.signal});
      clearTimeout(t);
      if(!r.ok) return null;
      const j = await r.json();
      if (j && j.success !== false && j.country_code) {
        return mapCC(j.country_code.toUpperCase());
      }
      return null;
    }catch(e){ clearTimeout(t); return null; }
  }
  function detectBrowserLang(){
    const raw = (navigator.language || (Intl.DateTimeFormat().resolvedOptions().locale) || 'en').toLowerCase();
    return normalizeLang(raw);
  }
  function mapCC(cc){
    switch (cc) {
      case 'KR': return 'ko';
      case 'JP': return 'ja';
      case 'CN': case 'HK': case 'MO': case 'TW': return 'zh';
      case 'IN': return 'hi';
      case 'FR': case 'BE': case 'CH': case 'CA': case 'LU': case 'MC': case 'SN': case 'CI': case 'CM': return 'fr';
      case 'ES': case 'MX': case 'AR': case 'CO': case 'CL': case 'PE': case 'VE': case 'UY': case 'PY': case 'BO': case 'EC': case 'GT': case 'CU': case 'DO': case 'HN': case 'NI': case 'SV': case 'CR': case 'PA': case 'GQ': return 'es';
      case 'SA': case 'AE': case 'EG': case 'QA': case 'KW': case 'OM': case 'BH': case 'JO': case 'PS': case 'IQ': case 'YE': case 'LY': case 'DZ': case 'MA': case 'TN': case 'SD': return 'ar';
      default: return 'en';
    }
  }
})();
</script>
</body>
</html>
